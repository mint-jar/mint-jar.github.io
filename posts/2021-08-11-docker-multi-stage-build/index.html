<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Docker Multi-stage build | Mint-Jar.github.io</title>
<meta name=keywords content="today-i-learned,docker">
<meta name=description content="In our latest project I encountered some new quirks within Docker while using multi stage builds for the first time.">
<meta name=author content>
<link rel=canonical href=https://mint-jar.github.io/posts/2021-08-11-docker-multi-stage-build/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.6cba0d81b5f3f42bb578d49f402ba4175aa72b43def148780b8ad714c957c6f5.css integrity="sha256-bLoNgbXz9Cu1eNSfQCukF1qnK0Pe8Uh4C4rXFMlXxvU=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://mint-jar.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://mint-jar.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://mint-jar.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://mint-jar.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://mint-jar.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.87.0">
<meta property="og:title" content="Docker Multi-stage build">
<meta property="og:description" content="In our latest project I encountered some new quirks within Docker while using multi stage builds for the first time.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://mint-jar.github.io/posts/2021-08-11-docker-multi-stage-build/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-08-11T20:01:08+02:00">
<meta property="article:modified_time" content="2021-08-11T20:01:08+02:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Docker Multi-stage build">
<meta name=twitter:description content="In our latest project I encountered some new quirks within Docker while using multi stage builds for the first time.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://mint-jar.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Docker Multi-stage build","item":"https://mint-jar.github.io/posts/2021-08-11-docker-multi-stage-build/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Docker Multi-stage build","name":"Docker Multi-stage build","description":"In our latest project I encountered some new quirks within Docker while using multi stage builds for the first time.\n","keywords":["today-i-learned","docker"],"articleBody":"In our latest project I encountered some new quirks within Docker while using multi stage builds for the first time.\nAt first glance, it looks really simple:\nFROMalpine:latest AS baseWORKDIR/testRUN touch baseFROMbase AS developRUN touch developFROMbase AS productionRUN touch productionThe idea behind this is that you can target which stage you want and get the correct result.\nSo when I run the following command with this example:\ndocker build --target production -t mulibuild/example:latest . And check the touched files\ndocker run -it mulibuild/example:latest find . -maxdepth 1 -type f I will see the following:\n./production ./base As you can see, we only have the result of the base and production stage. Everything is working as expected.\nBut what if I introduce a command that fails?\nFROMalpine:latest AS baseWORKDIR/testRUN touch baseFROMbase AS developRUN break develop # FROMbase AS productionRUN touch productionWhen I run the same build command, as before it will fail now. Strange right?\nThis is due to the way docker builds from a docker file. Even if you create a multistage file it will run all stages until the target and combine the results of every build target as described. So in our example:\n base, develop and production stages are build base and production are combined  If I move the broken stage to the end it will work.\nFROMalpine:latest AS baseWORKDIR/testRUN touch baseFROMbase AS productionRUN touch productionFROMbase AS developRUN break developWhen running the build command, it will no longer fail as the build will stop once it reached its target.\n base and production are build develop is skipped as the target has been reached before ","wordCount":"269","inLanguage":"en","datePublished":"2021-08-11T20:01:08+02:00","dateModified":"2021-08-11T20:01:08+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mint-jar.github.io/posts/2021-08-11-docker-multi-stage-build/"},"publisher":{"@type":"Organization","name":"Mint-Jar.github.io","logo":{"@type":"ImageObject","url":"https://mint-jar.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://mint-jar.github.io accesskey=h title="Mint-Jar.github.io (Alt + H)">Mint-Jar.github.io</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Docker Multi-stage build
</h1>
<div class=post-meta>August 11, 2021
</div>
</header>
<div class=post-content><p>In our latest project I encountered some new quirks within Docker while using multi stage builds for the first time.</p>
<p>At first glance, it looks really simple:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> alpine:latest AS base</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /test</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> touch base<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> base AS develop</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> touch develop<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> base AS production</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> touch production<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>The idea behind this is that you can target which stage you want and get the correct result.</p>
<p>So when I run the following command with this example:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>docker build --target production -t mulibuild/example:latest . 
</code></pre></div><p>And check the touched files</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>docker run -it mulibuild/example:latest find . -maxdepth <span style=color:#ae81ff>1</span> -type f
</code></pre></div><p>I will see the following:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>./production
./base
</code></pre></div><p>As you can see, we only have the result of the base and production stage. Everything is working as expected.</p>
<p>But what if I introduce a command that fails?</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> alpine:latest AS base</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /test</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> touch base<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> base AS develop</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> break develop <span style=color:#75715e># &lt;-- Will break now!</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> base AS production</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> touch production<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>When I run the same build command, as before it will fail now. Strange right?</p>
<p>This is due to the way docker builds from a docker file. Even if you create a multistage file it will run all stages until the target and combine the results of every build target as described. So in our example:</p>
<ol>
<li>base, develop and production stages are build</li>
<li>base and production are combined</li>
</ol>
<p>If I move the broken stage to the end it will work.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> alpine:latest AS base</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /test</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> touch base<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> base AS production</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> touch production<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> base AS develop</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> break develop<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>When running the build command, it will no longer fail as the build will stop once it reached its target.</p>
<ol>
<li>base and production are build</li>
<li>develop is skipped as the target has been reached before</li>
</ol>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://mint-jar.github.io/tags/today-i-learned/>today-i-learned</a></li>
<li><a href=https://mint-jar.github.io/tags/docker/>docker</a></li>
</ul>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://mint-jar.github.io>Mint-Jar.github.io</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)">
<button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</button>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>